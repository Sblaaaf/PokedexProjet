{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Pokedex - Battle Arena</title>
    <link rel="stylesheet" href="{% static 'pokedex/style.css' %}">
</head>
<body>
    <div id="loader" class="loader">
        <img src="{% static 'img/pokemon_logo.svg' %}" class="loader-img">
        <p>Loading Pokedex data...</p>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirm Action</h3>
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-actions">
                <button class="btn-modal-cancel">Cancel</button>
                <button class="btn-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            document.getElementById('loader').style.display = 'none';
        });

        // Gestion de la modale de confirmation
        function showConfirmModal(title, message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.style.display = 'flex';

            const confirmBtn = modal.querySelector('.btn-modal-confirm');
            const cancelBtn = modal.querySelector('.btn-modal-cancel');

            const handleConfirm = () => {
                modal.style.display = 'none';
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                callback();
            };
            const handleCancel = () => {
                modal.style.display = 'none';
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // Go back to pokedex
        function goBack() {
            showConfirmModal('Back to Pokedex', 'Are you sure? This will end the battle.', () => {
                window.location.href = "{% url 'stop_combat' %}";
            });
        }
    </script>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img class="logo" src="{% static 'img/pokemon_logo.svg' %}" alt="Pokemon">
        </div>

        <div class="sidebar-content">
            <h2>Your Team</h2>
            <div class="team-list-battle">
                {% for member in player_team %}
                <div class="team-item-battle {% if forloop.counter0 == p_idx %}active{% endif %}">
                    <img src="{{ member.image }}" alt="{{ member.name }}">
                    <div class="team-info">
                        <p class="team-name">{{ member.name }}</p>
                        <div class="hp-bar-combat">
                            <div class="hp-fill-combat" style="width: {% widthratio member.hp member.hp_max 100 %}%"></div>
                        </div>
                        <div class="hp-stats-row">
                            <span class="hp-text-combat">{{ member.hp }}/{{ member.hp_max }}</span>
                            <span class="stats-text">{{ member.attack }} | {{ member.defense }}</span>
                        </div>
                    </div>
                    {% if forloop.counter0 != p_idx and member.hp > 0 %}
                        <a href="{% url 'switch_pokemon' forloop.counter0 %}" class="btn-switch-combat" title="Switch Pokémon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M566.6 214.6L470.6 310.6C461.4 319.8 447.7 322.5 435.7 317.5C423.7 312.5 416 300.9 416 288L416 224L96 224C78.3 224 64 209.7 64 192C64 174.3 78.3 160 96 160L416 160L416 96C416 83.1 423.8 71.4 435.8 66.4C447.8 61.4 461.5 64.2 470.7 73.3L566.7 169.3C579.2 181.8 579.2 202.1 566.7 214.6zM169.3 566.6L73.3 470.6C60.8 458.1 60.8 437.8 73.3 425.3L169.3 329.3C178.5 320.1 192.2 317.4 204.2 322.4C216.2 327.4 224 339.1 224 352L224 416L544 416C561.7 416 576 430.3 576 448C576 465.7 561.7 480 544 480L224 480L224 544C224 556.9 216.2 568.6 204.2 573.6C192.2 578.6 178.5 575.8 169.3 566.7z"/></svg></a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% if battle_started %}
            <a href="{% url 'reset_combat' %}" class="btn-sidebar-restart">Restart Battle</a>
            {% endif %}
        </div>
    </aside>

    <main class="main-content-battle">
        {% if battle_started %}
        <header class="battle-header-top">
            <div class="btn_back_container">
                <button class="btn-action-header" onclick="goBack()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M41.4 297.4C28.9 309.9 28.9 330.2 41.4 342.7L169.4 470.7C181.9 483.2 202.2 483.2 214.7 470.7C227.2 458.2 227.2 437.9 214.7 425.4L141.3 352L576 352C593.7 352 608 337.7 608 320C608 302.3 593.7 288 576 288L141.3 288L214.7 214.6C227.2 202.1 227.2 181.8 214.7 169.3C202.2 156.8 181.9 156.8 169.4 169.3L41.4 297.3z"/></svg> Back to Pokedex</button>
            </div>
            <div class="battle-title-wrapper">
                <h1 class="battle-title">Battle Arena</h1>
            </div>
        </header>

        <div class="arena-wrapper">
            <div class="battle-arena">
                {% if player_pk %}
                <div class="pokemon-zone player-zone">
                    <div class="pokemon-card">
                        <img src="{{ player_pk.image }}" alt="{{ player_pk.name }}" class="pokemon-img">
                        <div class="pokemon-info">
                            <p class="pokemon-name">{{ player_pk.name|upper }}</p>
                            <div class="types-container">
                                {% for type in player_pk.types %}
                                    <span class="type-badge type-{{ type }}">{{ type }}</span>
                                {% endfor %}
                            </div>
                            <div class="hp-bar">
                                <div class="hp-fill hp-fill-combat" style="width: {% widthratio player_pk.hp player_pk.hp_max 100 %}%"></div>
                            </div>
                            <span class="hp-text">{{ player_pk.hp }}/{{ player_pk.hp_max }}</span>
                        </div>
                    </div>
                </div>

                <div class="battle-vs">VS</div>
                {% endif %}

                <div class="pokemon-zone enemy-zone">
                    <div class="pokemon-card">
                        <img src="{{ ai_pk.image }}" alt="{{ ai_pk.name }}" class="pokemon-img">
                        <div class="pokemon-info">
                            <p class="pokemon-name">{{ ai_pk.name|upper }}</p>
                            <div class="types-container">
                                {% for type in ai_pk.types %}
                                    <span class="type-badge type-{{ type }}">{{ type }}</span>
                                {% endfor %}
                            </div>
                            <div class="hp-bar">
                                <div class="hp-fill hp-fill-combat" style="width: {% widthratio ai_pk.hp ai_pk.hp_max 100 %}%"></div>
                            </div>
                            <span class="hp-text">{{ ai_pk.hp }}/{{ ai_pk.hp_max }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if p_idx >= 5 %}
        <div class="battle-end defeat">
            <p class="end-title">DEFEAT!</p>
            <p class="end-message">Your entire team has been defeated.</p>
            <a href="{% url 'index' %}" class="btn-return">Return to Pokedex</a>
        </div>
        {% elif a_idx >= 5 %}
        <div class="battle-end victory">
            <p class="end-title">VICTORY!</p>
            <p class="end-message">You defeated all opponent Pokémon!</p>
            <div class="end-actions">
                <a href="{% url 'reset_combat' %}" class="btn-new-battle">New Battle</a>
                <a href="{% url 'index' %}" class="btn-return">Return to Pokedex</a>
            </div>
        </div>
        {% elif player_pk.hp <= 0 %}
        <div class="battle-status">
            <p class="status-message">Your {{ player_pk.name|upper }} has fainted!</p>
            <p class="status-hint">Select another Pokémon from your team to continue.</p>
        </div>
        {% elif player_pk.hp > 0 %}
        <div class="battle-actions">
            <a href="{% url 'attack_turn' %}" class="btn-attack">ATTACK</a>
        </div>
        {% endif %}
    </main>

    <aside class="sidebar sidebar-right">
        <div class="sidebar-content">
            <h2>Enemy Team</h2>
            <div class="team-list-battle">
                {% for member in ai_team %}
                <div class="team-item-battle {% if forloop.counter0 == a_idx %}active{% endif %}">
                    <img src="{{ member.image }}" alt="{{ member.name }}">
                    <div class="team-info">
                        <p class="team-name">{{ member.name }}</p>
                        <div class="hp-bar-combat">
                            <div class="hp-fill-combat" style="width: {% widthratio member.hp member.hp_max 100 %}%"></div>
                        </div>
                        <div class="hp-stats-row">
                            <span class="hp-text-combat">{{ member.hp }}/{{ member.hp_max }}</span>
                            <span class="stats-text">{{ member.attack }} | {{ member.defense }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if battle_started %}
            <a href="{% url 'new_opponent' %}" class="btn-sidebar-new">New Opponent</a>
            {% endif %}
        </div>
    </aside>

</body>
</html>